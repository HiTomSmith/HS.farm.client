<!DOCTYPE html>
<html style="height: 100%;">

	<head>
		<meta charset="UTF-8">
		<title>嗨森农业</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="theme-color" content="RGBA(181,209,237,0)">
		<meta name="msapplication-TileColor" content="#de7300">
		<link href="../../css/mui.css" rel="stylesheet" />
		<link href="../../css/FarmPay.css" rel="stylesheet" />
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
	</head>

	<body style="background-color: #F4F4F4;height: 100%;">
		<header class="mui-bar mui-bar-nav header" style="background-image: url(../../img/paymentbg.png);background-repeat: no-repeat;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">支付订单</h1>
			<div class="mui-row" style="position: relative;top: 44px;left: -18px;">
				<div class="mui-col-sm-8 mui-col-xs-8" style="height: 50px;padding-top: 3%;">
					<div class="mui-row" style="color: #ffffff;">
						<div class="mui-col-sm-12 mui-col-xs-12"><span style="font-size: 16px;">订单提交成功，请支付了！</span></div>
					</div>
					<!--<div class="mui-row" style="color: #ffffff;">
						<div class="mui-col-sm-12 mui-col-xs-12" style="font-size: 15px;">剩余:<span>2天12小时38分钟</span></div>
					</div>-->
				</div>
				<div class="mui-col-sm-3 mui-col-xs-3" style="height: 50px;display: flex;justify-content: center;padding-left: 28px;padding-top: 5px;">
					<p><img src="../../img/wallet.png" / width="68" height="40"></p>
				</div>
			</div>
		</header>
		<!--头部站位元素-->
		<div class="header-place" style="width: 100%;height: 1px;"></div>
		<div class="mui-content" style="margin-top: 60px;">
			<div class="mui-row order" style="padding-top: 3px;">
				<!--<div class="mui-col-sm-12 mui-col-xs-12">订单编号：<span class="orderNum">1234567890</span></div>-->
				<div class="mui-col-sm-12 mui-col-xs-12">应付金额:<span class="symbol">￥</span><span class="amount">00.00</span></div>
			</div>
			<div class="mui-row choose">
				<div class="mui-col-sm-12 mui-col-xs-12"><span>选择支付方式</span></div>
			</div>
			<div class="payWay">
				<!--<div class="mui-row balancePay">
		    		<div class="mui-col-sm-2 mui-col-xs-2 marginLeft  balanceFir"><img src="../../img/yuer.png" width="24" height="28"/></div>
		    		<div class="mui-col-sm-8 mui-col-xs-8 balanceSec font payment">余额支付(剩余:￥<span class="surplusMoney">11100.00</span>)</div>
		    		<div class="mui-col-sm-2 mui-col-xs-2 chooseCircle"><div class="circle"></div></div>
			    </div>-->
				<div class="mui-row alipay" style="background-color: #ooo; opacity:0.3;">
					<div class="mui-col-sm-2 mui-col-xs-2 marginLeft aliFir"><img src="../../img/zfb.png" width="29" height="28" /></div>
					<div class="mui-col-sm-8 mui-col-xs-8 aliSec font payment">支付宝支付</div>
					<div class="mui-col-sm-2 mui-col-xs-2 chooseCircle">
						<div class="iconfont circle"></div>
					</div>
				</div>
				<div class="mui-row weChatPay" style="background-color: #ooo; opacity:0.3;">
					<div class="mui-col-sm-2 mui-col-xs-2 marginLeft weChatFir"><img src="../../img/wx.png" width="33" height="28" /></div>
					<div class="mui-col-sm-8 mui-col-xs-8 weChatSec font payment">微信支付</div>
					<div class="mui-col-sm-2 mui-col-xs-2 chooseCircle">
						<div class="circle"></div>
					</div>
				</div>
				<!--<div class="mui-row unionPay">
		    		<div class="mui-col-sm-2 mui-col-xs-2 marginLeft unionFir"><img src="../../img/yinlian.png" width="42" height="22"/></div>
		    		<div class="mui-col-sm-8 mui-col-xs-8 unionSec font">银联支付</div>
		    		<div class="mui-col-sm-2 mui-col-xs-2 chooseCircle"><div><img src="../../img/biglogo.png"/ width="20" height="20"></div></div>
			    </div>-->
				<div class="mui-row offlinePay">
					<div class="mui-col-sm-2 mui-col-xs-2 marginLeft offlineFir"><span class="iconfont margin-right color">&#xe629;</span></div>
					<div class="mui-col-sm-8 mui-col-xs-8 offlineSec font payment">线下支付</div>
					<div class="mui-col-sm-2 mui-col-xs-2 chooseCircle">
						<div><img src="../../img/biglogo.png" / width="20" height="20"></div>
					</div>
				</div>
			</div>
			<div class="payButton">
				<button type="button" class="mui-btn" id="goPay">去支付</button>
			</div>
		</div>
	</body>

</html>
<script src="../../js/mui.js"></script>
<script src="../../js/mui.enterfocus.js"></script>
<script src="../../js/jquery-2.1.4.min.js"></script>
<script src="../../js/jquery.serialize-json.js"></script>
<script src="../../js/mui.picker.min.js"></script>
<script src="../../js/mui.poppicker.min.js"></script>
<script src="../../js/validator.js"></script>
<script src="../../js/hx.functor.js"></script>
<script src="../../js/app.js"></script>
<script src="../../js/data-unit.js"></script>
<script src="../../js/setData.js"></script>
<script src="../../js/getData.js"></script>
<script>
	mui.init();
	var UserInfo, leasePay, payment;
	app.ready(function() {
		UserInfo = app.accountInfo('info');
		console.log("用户信息：" + JSON.stringify(UserInfo))
		webData = plus.webview.currentWebview();
		console.log(JSON.stringify("webData:" + JSON.stringify(webData)))
		payObject.fillData();
		payObject.getBalance();
		payObject.getLeaseList();
		payObject.tap();
	});
	var payObject = {
		/*填充数据*/
		fillData: function() {
			$(".orderNum").text(); //订单编号
			$(".amount").text(webData.entity.Money); //应付金额

		},
		/*账户余额*/
		getBalance: function() {
			var option = {
				api: '/PlanManage/LeaseTable/AccountUserInfo',
				data: {
					userid: UserInfo.UserId
				},
				success: function(data) {
					var row = JSON.parse(data);
					console.log(JSON.stringify(row))
					if(row["type"] == 1) {
						$(".surplusMoney").text((row.message) ? row.message : '0.00'); //余额
					} else {
						app.toast('获取账户余额失败');
					};
				},
				error: function(data) {
					app.toast('获取账户余额失败');
				}
			};
			app.post3_4(option)
		},
		/*获取leaseTable2数据*/
		getLeaseList: function() {
			leasePay = [];
			var deleteMoney = 0;
			var option = {
				api: '/PlanManage/LeaseTable2/GetPageListJson',
				data: {
					"page": 1,
					"rows": 100,
					"sidx": "CreateDate",
					"sord": "desc",
					"queryJson": JSON.stringify({
						UserInfoId: UserInfo.UserId,
						LeaseState: 0
					})
				},
				success: function(data) {
					var result = JSON.parse(data);
					var rows = result['rows'];
					for(var i in rows) {
						var row = rows[i];
						console.log("订单信息：" + JSON.stringify(row))
						leasePay.push({
							"LeaseTableId2": row['LeaseTableId2'],
							"UavNumber": 1,
							"LeaseState": 1,
							"UserInfoId": UserInfo.UserId
						});
						console.log(JSON.stringify(leasePay))
						return false;
					};
				},
				error: function() {
					plus.nativeUI.closeWaiting();
				}
			}
			app.post3_4(option);
		},

		//更改租赁表2
		setLeaseTable2: function(leasePay) {
			console.log("leasePay:" + JSON.stringify(leasePay))
			var option = {
				api: '/PlanManage/LeaseTable/UpState',
				data: {
					list: leasePay
				},
				success: function(data) {
					console.log(JSON.stringify("支付数据：" + JSON.stringify(data)));
					var result = JSON.parse(data);
					if(result['type'] == "1") {
						app.toast('下单成功，请在2小时之内付款');
						plus.nativeUI.closeWaiting();
					} else {
						app.toast('支付失败');
					};
					//支付成功后刷新上个页面
					var ShoppingCart = plus.webview.getWebviewById('ShoppingCart');
					mui.fire(ShoppingCart, "pageflowerfresh");
				},
				error: function() {
					plus.nativeUI.closeWaiting();
				},
			};
			app.post3_3(option);
		},

		/*点击选择按钮*/
		tap: function() {
			//			$(".chooseCircle>div").each(function(i){
			//				 $(".chooseCircle>div").eq(i).on('tap',function(){
			//				 	
			//				 	$(".chooseCircle>div").html('');
			//				 	$(".chooseCircle>div").addClass("circle");
			//				 	
			//				 	$(".chooseCircle>div").eq(i).html('');
			//				 	$(".chooseCircle>div").eq(i).removeClass("circle")
			//				 	var $html = $('<img src="../../img/biglogo.png"/ width="20" height="20">');
			//				 	$html.appendTo($(".chooseCircle>div").eq(i));
			//				 	payment = $(".payment").eq(i).html();
			//				 	
			//				 })
			//			});

			/*支付*/
			$("#goPay").on('tap', function() {
				if(payment == undefined) {
					payment = '线下支付'
				};
				var sendData = {
					LeaseTableId: webData.entity.LeaseTableId,
					RenewNumber: webData.entity.RenewNumber,
					GroupDetailsID: webData.entity.GroupDetailsID
				}
				LeaseInterface.Renew(sendData, function(cb) {
					console.log("返回结果："+JSON.stringify(cb))
					if(cb.type == 1) {
						switch(payment) {
							case '线下支付':
								mui.openWindow({
									url: '../Lease/Pay.html',
									id: 'Pay',
									extras: {
										total: $(".amount").text()
									}
								});
								break;
						}
					}
					
				});

			})

		}
	}
</script>