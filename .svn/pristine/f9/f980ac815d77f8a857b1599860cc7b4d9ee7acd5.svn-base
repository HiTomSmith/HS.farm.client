<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../../css/mui.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/myStyle.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/batteryOrder.css" />
		<style type="text/css">
			.iconfont {
				font-size: 12px;
				color: #717171;
				position: absolute;
				top: 12px;
				right: 5px;
				text-align: right;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">分期明细</h1>
		</header>
		<div class="mui-content mui-scroll-wrapper" style="position: relative;">
			<ul class="mui-table-view">
				<!--<li class="mui-table-view-cell list">
				<div class="Address">
					<p style="margin-bottom: 7px;">
						<span class="black-color font-14">收货地址</span>
						<span class="mui-icon mui-ellipsis iconfont  address font-14">请选择&#xe741;</span>
					</p>
					<p>
						<span class="gray-color Moblie font-14">17631802351</span>
						<span class="mui-pull-right gray-color name font-14" style="text-align: right;">王欣梅&nbsp;&nbsp;&nbsp;</span>
					</p>
				</div>
			</li>-->
				<li class="mui-table-view-cell list">
					<div class="orderNum">
						<div class="orderNum_number underline gray-color">
							<img class="mui-media-object mui-pull-left Icon" src="../../../img/battey.png">
							<span class="font-16 orderNumber">订单号：2018040401</span>
							<span class="mui-pull-right font-14  time">04-06</span>
						</div>
						<div class="orderNum_pay">
							<span class="gray-color font-14">分期付款</span>
							<span class="mui-pull-right blue-color priceto font-14">20700&nbsp;元</span>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell list">
					<div class="purchase gray-color" style="height: auto;">
						<div class="purchase-o font-16 underline" style="height: 60px; line-height: 60px;">采购详情</div>
						<div class="purchase-o font-14 underline">收货人：<span class="name font-14">暂无</span></div>
						<div class="purchase-o font-14 underline">联系方式：<span class="Moblie font-14">暂无</span></div>
						<div class="purchase-o font-14 underline">收货地址：<span class="address font-14">暂无</span></div>
						<!--<div class="purchase-t">
						<span class="font-14 ">植保机电池*6块+充电器</span>
						<span class="mui-pull-right font-14 blue-color">x1&nbsp;&nbsp;&nbsp;&nbsp;20700</span>
				    </div>-->
					</div>
				</li>
				<li class="mui-table-view-cell list gray-color" id="DividedMX">
					
					<div class="underline font-16" style="height: 40px; line-height: 40px;">分期明细</div>
					
					<div id= "fengqi">
						
					
					
					
<!--					<div class="bottom underline">
						<p style="margin:7px 0px;">
							<span class="font-14">1/3期</span>
							<span class="mui-pull-right blue-color font-14 priceto2">¥&nbsp;&nbsp;11700</span>
						</p>
						<p>
							<span class="font-14">还款日&nbsp;&nbsp;<b class="font-14 pay1" style="font-weight: normal;">20180109</b></span>
							<span class="mui-pull-right font-14 state1">未付款</span>
						</p>
					</div>
					<div class="bottom gray-color underline">
						<p style="margin:7px 0px;">
							<span class="font-14">2/3期</span>
							<span class="mui-pull-right blue-color font-14 priceto3">¥&nbsp;&nbsp;6700</span>
						</p>
						<p>
							<span class="font-14">还款日&nbsp;&nbsp;<b class="font-14 pay2" style="font-weight: normal;">20190109</b></span>
							<span class="mui-pull-right font-14 state2">未付款</span>
						</p>
					</div>
					<div class="bottom gray-color underline">
						<p style="margin:7px 0px;">
							<span class="font-14">3/3期</span>
							<span class="mui-pull-right blue-color font-14 priceto4">¥&nbsp;&nbsp;1700</span>
						</p>
						<p>
							<span class="font-14">还款日&nbsp;&nbsp;<b class="font-14 pay3" style="font-weight: normal;">20200109</b></span>
							<span class="mui-pull-right font-14 save state3">未付款</span>
						</p>
					</div>-->
					
					</div>
					<div class="bottom gray-color">
						<p style="margin:7px 0px;">
							<span></span>
							<span class="mui-pull-right blue-color"></span>
						</p>
						<p>
							<span></span>
							<span class="mui-pull-right"></span>
						</p>
					</div>
					<div class="bottom gray-color">
						<p style="margin:7px 0px;">
							<span></span>
							<span class="mui-pull-right blue-color"></span>
						</p>
						<p>
							<span></span>
							<span class="mui-pull-right"></span>
						</p>
					</div>
					<div class="bottom gray-color">
						<p style="margin:7px 0px;">
							<span></span>
							<span class="mui-pull-right blue-color"></span>
						</p>
						<p>
							<span></span>
							<span class="mui-pull-right"></span>
						</p>
					</div>
				</li>
			</ul>
			<button class="mui-btn mui-btn-blue mui-btn-block btn">立即扣款</button>
		</div>
	</body>

</html>
<script src="../../../js/mui.min.js"></script>
<script src="../../../js/webviewGroup.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/mui.picker.min.js"></script>
<script src="../../../js/mui.poppicker.min.js"></script>
<script src="../../../js/mui.enterfocus.js"></script>
<script src="../../../js/jquery-2.1.4.min.js"></script>
<script src="../../../js/jquery.serialize-json.js"></script>
<script src="../../../js/validator.js"></script>
<script src="../../../js/hx.functor.js"></script>
<script src="../../../js/app.js"></script>
<script src="../../../js/data-unit.js"></script>
<script src="../../../js/getData.js"></script>
<script src="../../../js/setData.js"></script>
<script type="text/javascript">
	mui.init({
		swipeBack: false
	});
	mui('.mui-scroll-wrapper').scroll({
		indicators: false //不显示滚动条
	});
	var _self, time1, time2, time3;
	app.ready(function() {
		_self = plus.webview.currentWebview();
		getOrderDeductions();
		//setDividedMX();
		fill();
		nowPayment();

		if(_self.data.AuditStatus > 6)(
			$(".btn").attr("style", "display:none")
		)
	priceList();
	
	});
	//获取扣费列表
	function getOrderDeductions() {
		var sendData = {
			"page": 1,
			"rows": 100,
			"sidx": "CreateDate",
			"sord": "desc",
			"queryJson": JSON.stringify({
				//				UserInfoId: UserInfo.UserId
			})
		};
		Orders.OrderDetail(sendData, function(cb) {
//			console.log(JSON.stringify(cb))
			var payTime1, payTime2;
			var rows = cb.rows;
			for(var i in rows) {
				var row = rows[i];
//				console.log(row.WithholdTime)
				if(_self.data.GoodOrder == row.GoodsOrderId) {
					if(row.Description == "3期(1/3)") {
						payTime1 = row.WithholdTime.substr(0, 10);
						$(".state1").text("已付款");
						$(".pay1").text(payTime1);
					} else if(row.Description == "3期(2/3)") {
						payTime2 = row.WithholdTime.substr(0, 10);
						$(".state1").text("已付款");
						$(".state2").text("已付款");
						$(".pay1").text(payTime1);
						$(".pay2").text(payTime2);
					} else if(row.Description == "3期(3/3)") {
						$(".state1").text("已付款");
						$(".state2").text("已付款");
						$(".state3").text("已付款");
						$(".pay1").text(payTime1);
						$(".pay2").text(payTime2);
						$(".pay3").text(row.WithholdTime.substr(0, 10));
					} else {

					}
				}
			}
		});
	}

	function fill() {
		var data = _self.data;
		
		$(".orderNumber").text(data['OrderNumber']); //订单号
		$(".time").text(data['CreateDate'].substr(0, 10)); //订单日期
		$(".name").text(data['ReceivingMan']); //采购人
		$(".Moblie").text(data['ReceivingTele']); //手机号
		$(".address").text(data['ReceivingAddress']); //地址
		$(".priceto").text(+data['PayMoney'] + "元");
		
	}
	function priceList(){
		var sendData={
			"queryJson":JSON.stringify({GoodsOrderId:_self.data.GoodOrder})
			
		}
		Orders.OrderDetailList(sendData,function(cb){
			
//			console.log(JSON.stringify(cb)); 
//
//		    var sss=	cb.sort (function(a,b){
//				console.log(JSON.stringify(a));
//				return a['Description'].localeCompare(b['Description'])
//				});
//			console.log(JSON.stringify(sss));

//			var arr = [{name: "zlw", age: 24}, {name: "wlz", age: 25}];
//			function _convert1(str)
//			{
//			    var arr = ["一","二","三","四","五","六","七","八","九","十"];
//			    for (var i = 0; i < arr.length; i++) {
//			        str = str.replace(new RegExp(arr[i], "g"), (i+1));
//			    }
//			    return str;
//			}
//			
//			var compare = function (array1, array2) {
//				for(var i=1;i<array1.Description.length;i++){
//					
//					var val1 = _convert1(array1.Description[i]);
//				    var val2 = _convert1(array2.Description[i]);
//				    
//				    if (val1 < val2) {
//				    	
//				        return -1;
//				    } else if (val1 > val2) {
//				        return 1;
//				    } else {
//				        return 0;
//			    	}   
//			    	
//				}
//			             
//			} 
//			
//			console.log(JSON.stringify(cb.sort(compare)));
						

			
			for(var i=0;i<cb.length;i++){
				var row= cb[i];			
			    var $html = $(				
				'<div class="bottom underline">' +
						'<p style="margin:7px 0px;">' +
							'<span class="font-14">'+row.Description+'</span>' +
							'<span class="mui-pull-right blue-color font-14 priceto2">¥&nbsp;&nbsp;'+ row.Quota+'</span>' +
						'</p>' +
						'<p>' +
							'<span class="font-14">还款日&nbsp;&nbsp;<b class="font-14 pay1" style="font-weight: normal;">'+row.WithholdTime.substr(0,10)+'</b></span>' +
							'<span class="mui-pull-right font-14 state1">'+ (row.IsPay?'已付款':"未付款") +'</span>' +
						'</p>' +
					'</div>' )
			    $html.appendTo($('#fengqi'));
			
			}
			
			
		})
			
		
	}

	function setDividedMX() {
		var $html = "";
		var $html = $(
			'<div class="underline font-16" style="height: 40px; line-height: 40px;">分期明细</div>' +
			'<div class="bottom underline">' +
			'<p style="margin:7px 0px;">' +
			'<span class="font-14">1/3期</span>' +
			'<span class="mui-pull-right blue-color font-14 priceto2">¥&nbsp;&nbsp;11700</span>' +
			'</p>' +
			'<p>' +
			'<span class="font-14">还款日&nbsp;&nbsp;<b class="font-14 pay1" style="font-weight: normal;">20180109</b></span>' +
			'<span class="mui-pull-right font-14 state1">未付款</span>' +
			'</p>' +
			'</div>' +
			'<div class="bottom gray-color underline">' +
			'<p style="margin:7px 0px;">' +
			'<span class="font-14">2/3期</span>' +
			'<span class="mui-pull-right blue-color font-14 priceto3">¥6700</span>' +
			'</p>' +
			'<p>' +
			'<span class="font-14">还款日&nbsp;&nbsp;<b class="font-14 pay2" style="font-weight: normal;">20190109</b></span>' +
			'<span class="mui-pull-right font-14 state2">未付款</span>' +
			'</p>' +
			'</div>' +
			'<div class="bottom gray-color underline">' +
			'<p style="margin:7px 0px;">' +
			'<span class="font-14">3/3期</span>' +
			'<span class="mui-pull-right blue-color font-14 priceto4">¥1700</span>' +
			'</p>' +
			'<p>' +
			'<span class="font-14">还款日&nbsp;&nbsp;<b class="font-14 pay3" style="font-weight: normal;">20200109</b></span>' +
			'<span class="mui-pull-right font-14 state3">未付款</span>' +
			'</p>' +
			'</div>'

		);
		$html.appendTo($("#DividedMX"))
	}
	//扣款
	function nowPayment() {
		var data = _self.data;

		$(".btn").on('tap', function() {

			var qixian = "";

			if(data.AuditStatus == 5) {
				qixian = "第二期"
			} else if(data.AuditStatus == 6) {
				qixian = "第三期"
			} else {
				qixian = "第一期"
			}
			var send = {
				orderId: _self.data.GoodOrder,
				qixian: qixian
			};

			dialog.Dialogbox('电池扣款', '确定扣款', function(cb) {
				if(cb == 1) {
					SetOrder.BatteryFQPayment(send, function(cb) {
//						console.log(JSON.stringify(cb))
						if(cb['type'] == 1) {
							mui.toast("扣款成功！")
							var FatherView = plus.webview.getWebviewById("batteryOrder");
							mui.fire(FatherView, 'fresh');
							mui.back();
						} else {
							app.toast('扣款失败');
						};
					});
				} else if(cb == 0) {
					dialog.CloseLogBox();
				} else {
					app.toast('已取消');
				}

			})
		});
	}
</script>